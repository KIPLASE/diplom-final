<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç –ü–æ–∏—Å–∫ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ - –¶–≤–µ—Ç–æ—á–Ω—ã–µ –ü—Ä–æ–º–æ–∫–æ–¥—ã</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .search-filters {
            background: white;
            padding: 1.5rem;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        .filter-group {
            margin-bottom: 1rem;
        }
        .filter-label {
            font-weight: bold;
            color: {{ colors.violet }};
            margin-bottom: 0.5rem;
            display: block;
        }
        .results-count {
            background: {{ colors.lavender }};
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 1rem;
        }
        .sort-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .sort-btn {
            padding: 8px 15px;
            border: 2px solid {{ colors.lilac }};
            background: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .sort-btn.active {
            background: {{ colors.lilac }};
            color: white;
        }
        .sort-btn:hover {
            transform: translateY(-2px);
        }
        .discount-range {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .discount-input {
            width: 100px;
            padding: 8px;
            border: 2px solid {{ colors.lavender }};
            border-radius: 8px;
        }
        .flower-type-badge {
            padding: 5px 10px;
            margin: 2px;
            border-radius: 15px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .flower-type-badge:hover {
            transform: scale(1.05);
        }
    </style>
</head>
<body>
<!-- –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è –¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü -->
<nav class="navbar navbar-expand-lg navbar-dark" style="background: linear-gradient(135deg, {{ colors.rose }}, {{ colors.violet }});">
    <div class="container">
        <a class="navbar-brand" href="/">
            <i class="fas fa-seedling me-2"></i>–¶–≤–µ—Ç–æ—á–Ω—ã–µ –ü—Ä–æ–º–æ–∫–æ–¥—ã
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item">
                    <a class="nav-link {% if request.url.path == '/' %}active{% endif %}" href="/">
                        <i class="fas fa-home me-1"></i>–ì–ª–∞–≤–Ω–∞—è
                    </a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle {% if 'search' in request.url.path %}active{% endif %}" href="#" id="searchDropdown" role="button" data-bs-toggle="dropdown">
                        <i class="fas fa-search me-1"></i>–ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="/search">
                            <i class="fas fa-search me-2"></i>–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><h6 class="dropdown-header">–ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –ø–æ —Ç–∏–ø–∞–º:</h6></li>
                        {% for type_name, emoji in flower_types.items() %}
                        <li>
                            <a class="dropdown-item" href="/search?flower_type={{ type_name }}">
                                {{ emoji }} {{ type_name }}
                            </a>
                        </li>
                        {% endfor %}
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item" href="/search?sort_by=discount_high">
                                <i class="fas fa-percentage me-2"></i>–ë–æ–ª—å—à–∏–µ —Å–∫–∏–¥–∫–∏
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="/search?sort_by=newest">
                                <i class="fas fa-clock me-2"></i>–ù–æ–≤—ã–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã
                            </a>
                        </li>
                    </ul>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if 'rating' in request.url.path %}active{% endif %}" href="/rating">
                        <i class="fas fa-trophy me-1"></i>–†–µ–π—Ç–∏–Ω–≥
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if 'recommendations' in request.url.path %}active{% endif %}" href="/recommendations">
                        <i class="fas fa-lightbulb me-1"></i>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if 'howto' in request.url.path %}active{% endif %}" href="/howto">
                        <i class="fas fa-book me-1"></i>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
                    </a>
                </li>
            </ul>

            <div class="navbar-nav">
                {% if username %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user me-1"></i>{{ username }}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="/add_promo">
                                <i class="fas fa-plus-circle me-2"></i>–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥
                            </a></li>
                            <li><a class="dropdown-item" href="/my_promocodes">
                                <i class="fas fa-tags me-2"></i>–ú–æ–∏ –ø—Ä–æ–º–æ–∫–æ–¥—ã
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="/about">
                                <i class="fas fa-info-circle me-2"></i>–û —Å–∞–π—Ç–µ
                            </a></li>
                            <li><a class="dropdown-item" href="/logout">
                                <i class="fas fa-sign-out-alt me-2"></i>–í—ã–π—Ç–∏
                            </a></li>
                        </ul>
                    </li>
                {% else %}
                    <li class="nav-item">
                        <a class="nav-link" href="/login">
                            <i class="fas fa-sign-in-alt me-1"></i>–í–æ–π—Ç–∏
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/register">
                            <i class="fas fa-user-plus me-1"></i>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                        </a>
                    </li>
                {% endif %}
            </div>
        </div>
    </div>
</nav>
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <nav class="navbar">
        <div class="container">
            <a href="/" class="navbar-brand">
                <i class="fas fa-seedling"></i> –¶–≤–µ—Ç–æ—á–Ω—ã–µ –ü—Ä–æ–º–æ–∫–æ–¥—ã
            </a>
            <ul class="navbar-nav">
                <li><a href="/" class="nav-link"><i class="fas fa-home"></i> –ì–ª–∞–≤–Ω–∞—è</a></li>
                <li><a href="/search" class="nav-link active"><i class="fas fa-search"></i> –ü–æ–∏—Å–∫</a></li>
                <li><a href="/rating" class="nav-link"><i class="fas fa-trophy"></i> –†–µ–π—Ç–∏–Ω–≥</a></li>
                <li><a href="/recommendations" class="nav-link"><i class="fas fa-lightbulb"></i> –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</a></li>
                <li><a href="/howto" class="nav-link"><i class="fas fa-book"></i> –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</a></li>
                <li><a href="/about" class="nav-link"><i class="fas fa-info-circle"></i> –û —Å–∞–π—Ç–µ</a></li>
                {% if username %}
                    <li><a href="/logout" class="nav-link"><i class="fas fa-sign-out-alt"></i> –í—ã–π—Ç–∏</a></li>
                {% else %}
                    <li><a href="/login" class="nav-link"><i class="fas fa-sign-in-alt"></i> –í–æ–π—Ç–∏</a></li>
                {% endif %}
            </ul>
        </div>
    </nav>

    <div class="container">
        <h1 class="mb-4"><i class="fas fa-search"></i> –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤</h1>

        <!-- –§–æ—Ä–º–∞ –ø–æ–∏—Å–∫–∞ -->
        <div class="search-filters">
            <form method="get" action="/search" id="searchForm">
                <div class="row">
                    <div class="col-md-8">
                        <div class="filter-group">
                            <label class="filter-label"><i class="fas fa-search"></i> –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é</label>
                            <input type="text" class="form-control" name="query" value="{{ query or '' }}"
                                   placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥, –º–∞–≥–∞–∑–∏–Ω –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ...">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="filter-group">
                            <label class="filter-label"><i class="fas fa-store"></i> –ú–∞–≥–∞–∑–∏–Ω</label>
                            <input type="text" class="form-control" name="shop" value="{{ shop or '' }}"
                                   placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞...">
                        </div>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="filter-group">
                            <label class="filter-label"><i class="fas fa-filter"></i> –¢–∏–ø —Ü–≤–µ—Ç–æ–≤</label>
                            <div class="sort-options">
                                <button type="button" class="flower-type-badge" onclick="setFlowerType('all')"
                                        style="{% if not flower_type or flower_type == 'all' %}background: {{ colors.rose }}; color: white;{% else %}background: {{ colors.lavender }};{% endif %}">
                                    –í—Å–µ —Ç–∏–ø—ã
                                </button>
                                {% for type_name, emoji in flower_types.items() %}
                                <button type="button" class="flower-type-badge" onclick="setFlowerType('{{ type_name }}')"
                                        style="{% if flower_type == type_name %}background: {{ colors.rose }}; color: white;{% else %}background: {{ colors.lavender }};{% endif %}">
                                    {{ emoji }} {{ type_name }}
                                </button>
                                {% endfor %}
                            </div>
                            <input type="hidden" name="flower_type" id="flowerTypeInput" value="{{ flower_type or 'all' }}">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="filter-group">
                            <label class="filter-label"><i class="fas fa-percentage"></i> –°—É–º–º–∞ —Å–∫–∏–¥–∫–∏</label>
                            <div class="discount-range">
                                <input type="number" class="discount-input" name="min_discount"
                                       value="{{ min_discount or '' }}" placeholder="–û—Ç" min="0" max="100">
                                <span>-</span>
                                <input type="number" class="discount-input" name="max_discount"
                                       value="{{ max_discount or '' }}" placeholder="–î–æ" min="0" max="100">
                                <span>%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="filter-group mt-3">
                    <label class="filter-label"><i class="fas fa-sort"></i> –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
                    <div class="sort-options">
                        {% set sort_options = [
                            ("newest", "–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ", "fa-calendar-plus"),
                            ("oldest", "–°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ", "fa-calendar-minus"),
                            ("discount_high", "–ë–æ–ª—å—à–∞—è —Å–∫–∏–¥–∫–∞", "fa-sort-amount-down-alt"),
                            ("discount_low", "–ú–∞–ª–µ–Ω—å–∫–∞—è —Å–∫–∏–¥–∫–∞", "fa-sort-amount-up"),
                            ("popular", "–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ", "fa-fire")
                        ] %}
                        {% for value, text, icon in sort_options %}
                        <button type="button" class="sort-btn {% if sort_by == value %}active{% endif %}"
                                onclick="setSort('{{ value }}')">
                            <i class="fas {{ icon }}"></i> {{ text }}
                        </button>
                        {% endfor %}
                    </div>
                    <input type="hidden" name="sort_by" id="sortByInput" value="{{ sort_by or 'newest' }}">
                </div>

                <div class="mt-4">
                    <button type="submit" class="btn" style="background: {{ colors.rose }}; color: white; padding: 10px 30px;">
                        <i class="fas fa-search"></i> –ù–∞–π—Ç–∏ –ø—Ä–æ–º–æ–∫–æ–¥—ã
                    </button>
                    <a href="/search" class="btn" style="background: {{ colors.lavender }}; margin-left: 10px;">
                        <i class="fas fa-redo"></i> –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                    </a>
                </div>
            </form>
        </div>

        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
        <div class="results-count">
            <i class="fas fa-list"></i> –ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤: <strong>{{ promocodes|length }}</strong>
        </div>

        {% if promocodes %}
        <div class="row">
            {% for promo in promocodes %}
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="promo-card">
                    <div class="promo-emoji">{{ promo.emoji }}</div>

                    <h4>
                        <span class="badge" style="background: {{ colors.rose }}; color: white;">
                            {{ promo.code }}
                        </span>
                    </h4>

                    <h5><i class="fas fa-store"></i> {{ promo.shop }}</h5>

                    <div class="mb-2">
                        <span class="badge" style="background: {{ colors.sunflower }}; color: #333;">
                            <i class="fas fa-percentage"></i> {{ promo.discount }}
                        </span>
                        <span class="badge" style="background: {{ colors.leaf }}; color: white;">
                            {{ promo.flower_type }} {{ flower_types.get(promo.flower_type, 'üíê') }}
                        </span>
                    </div>

                    {% if promo.description %}
                    <p><i class="fas fa-info-circle"></i> {{ promo.description }}</p>
                    {% endif %}

                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div>
                            <small class="text-muted">
                                <i class="far fa-clock"></i> {{ promo.created_at }}<br>
                                <i class="fas fa-copy"></i> –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–π: {{ popularity_stats.get(promo.id, {}).get('copies', 0) }}
                            </small>
                        </div>

                        <div>
                            <button class="btn btn-sm copy-btn" data-code="{{ promo.code }}"
                                    style="background: {{ colors.violet }}; color: white;"
                                    onclick="trackAction({{ promo.id }}, 'copy')">
                                <i class="fas fa-copy"></i> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="alert alert-info text-center">
            <h4><i class="fas fa-search"></i> –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h4>
            <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ –∏–ª–∏ <a href="/">–≤–µ—Ä–Ω–∏—Ç–µ—Å—å –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a></p>
        </div>
        {% endif %}
    </div>

    <script>
        function setFlowerType(type) {
            document.getElementById('flowerTypeInput').value = type;
        }

        function setSort(sortValue) {
            document.getElementById('sortByInput').value = sortValue;
            document.getElementById('searchForm').submit();
        }

        function trackAction(promoId, action) {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Ç—Ä–µ–∫–∏–Ω–≥
            fetch(`/track/${promoId}/${action}`)
                .then(response => response.json())
                .then(data => console.log('Action tracked:', data));
        }

        // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞
        document.querySelectorAll('.copy-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const code = this.getAttribute('data-code');
                navigator.clipboard.writeText(code).then(() => {
                    const original = this.innerHTML;
                    this.innerHTML = '<i class="fas fa-check"></i> –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                    this.style.background = '#32CD32';

                    setTimeout(() => {
                        this.innerHTML = original;
                        this.style.background = '{{ colors.violet }}';
                    }, 2000);
                });
            });
        });
    </script>
</body>
</html>